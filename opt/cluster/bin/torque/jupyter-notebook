#!/bin/bash
#
# shell script to start graphical Anaconda/jupyter-notebook webserver
# as a torque job
#
# 20210122 honlee: get list of available modules from /opt/_modules/anaconda? 
# 20170626 edwger: do NOT reload module if one is already loaded
# 20170217 edwger: initial torque wrapperscript
#

# load helper functions
source $CLUSTER_UTIL_ROOT/share/cluster-lib.sh

# check if environment module is configured
use_local_mod=0
module list > /dev/null 2>&1
if [ $? -ne 0 ]; then
    use_local_mod=1
    source $mydir/../../_modules/setup.sh
    module load cluster
fi

if [ $use_local_mod -eq 0 ]; then
    # the version pre-loaded by user externally
    ANACONDA_MODULE=$(for i in `echo $LOADEDMODULES | sed 's/:/ /g'`; do echo $i; done | awk '{if ($1 ~ /^anaconda/) {print $1}}')
else
    # take the default version
    ANACONDA_MODULE="anaconda3/4.3.0"
fi

#echo $ANACONDA_MODULE

## in case there are more than one anaconda modules, return the last one
ANACONDA_MODULE=`echo $ANACONDA_MODULE | awk '{print $NF}'`

#echo $ANACONDA_MODULE

#DEFAULT_VERSION=$(echo $ANACONDA_MODULE | sed 's/^anaconda.\///g')
DEFAULT_VERSION=$(echo $ANACONDA_MODULE)


#echo $DEFAULT_VERSION

# Find available Anaconda/jupyter-notebook versions and put in array.
NOTEBOOK_AVAIL=()
for ana in `ls -d /opt/_modules/anaconda?`
do
    #echo $ana
    for version in $(ls $ana/[0-9]* | sed 's/\/opt\/_modules\///g')
    do
        #echo Default version is: "${DEFAULT_VERSION}"
        #echo Checked version is: "${version}"
        if [ "${DEFAULT_VERSION}" == "${version}" ]; then
            #echo DEFAULT VERSION IS THE CHECKED VERSION
            NOTEBOOK_AVAIL+=("^"${version})
        else
            NOTEBOOK_AVAIL+=(${version})
        fi
    done
done
#echo Available jupyter-notebook versions: ${NOTEBOOK_AVAIL[*]}
#echo Number of available jupyter-notebook versions: ${#NOTEBOOK_AVAIL[@]}
#echo ${NOTEBOOK_AVAIL[1]}
#echo "${NOTEBOOK_AVAIL[*]}"

# Put available jupyter-notebook versions in reverse order (latest first)
#TMP_NOTEBOOK=$(echo "${NOTEBOOK_AVAIL[*]}")
n=${#NOTEBOOK_AVAIL[@]}
NOTEBOOK_AVAIL_REVERSE=`for (( i = n-1; i >= 0; i-- )); do echo -n "${NOTEBOOK_AVAIL[i]},"; done`

#echo ${NOTEBOOK_AVAIL[-1]}

# YAD example
#holidays=$(echo "Gold Coast,Bali,Phuket,Sydney,other")
#yad --title="My YAD Test" --text="Please enter your details:" --image="/usr/share/icons/phone.png" --form --date-format="%-d %B %Y" --separator="," --item-separator="," --field="First Name" --field="Last Name" --field="Status":RO --field="Date of birth":DT --field="Last holiday":CBE --field="List your 3 favourite foods:":TXT "" "" "All round good guy" "Click calendar icon" "$holidays"

SELECTION=$(yad \
    --center \
    --width=300 \
    --ontop \
    --buttons-layout=center \
    --title="Jupyter-Notebook" \
    --text="Select desired Anaconda/Jupyter-Notebook version:" \
    --text-align=center \
    --form \
    --separator=" " \
    --item-separator="," \
    --field="Anaconda/Jupyter-Notebook Version:":CB \
    "${NOTEBOOK_AVAIL_REVERSE:-1}")
ret=$?
#echo $ret
if [[ $ret -eq 1 ]] || [[ $ret -eq 252 ]]
then
    echo "Command Cancelled"; exit 0
fi

#Not much to select from in this case. For jupyter-notebook always the latest
#anaconda version is used: ${NOTEBOOK_AVAIL[-1]}
#echo $SELECTION

IFS=' ' read -r -a CHOICES <<< $SELECTION
NOTEBOOK_SELECTION=$(echo ${CHOICES[0]})

#echo Jupyter-Notebook-version: $NOTEBOOK_SELECTION

#echo NOTEBOOK-version: $NOTEBOOK_SELECTION
#echo Loaded-module:  $DEFAULT_VERSION

# If the menu selection equals the installed anaconda module do NOT 
# unload and reload modules!
# Only unload and reload modules if loaded and menu selected modules differ!
if [ "$DEFAULT_VERSION" != "$NOTEBOOK_SELECTION" ]; then
    # No module loaded or different version selected
    # First get rid of all the loaded modules
    module unload anaconda anaconda2 anaconda3 > /dev/null 2>&1

    # Find out the anaconda /opt directory in which the selected notebook
    # version is located. The combination specifies the module that has
    # to be loaded...
    # Load the required module
    echo "Loading module $NOTEBOOK_SELECTION ..."
    module load $NOTEBOOK_SELECTION
fi

#torque_run_guiapp RStudio /opt/rstudio/$RSTUDIO_SELECTION/bin/rstudio
torque_run_guiapp Jupyter-Notebook 'jupyter-notebook --ip=$(hostname -f) --notebook-dir=$PBS_O_WORKDIR' guimenu
