#!/bin/bash
#
# universal shell script to start a specific version of matlab
# the basename is: matlabXX
#     XX = the version of matlab, e.g. 70
#     -noX11tunnel = optional - try to circumvent ssh tunneling of X11 by
#             using the IP number of the client
#
# the basename of this script is a link to the real script
# the basename is used to figure out which version of matlab to start
#
# prereq: matlab is installed at standard location:
#            on linux at /opt
#            on solaris at /usr/local
#         matlab is installed in the default directory matlab{major version}{minor version}
#         patchlevels are NOT added
#         eg. matlab 7.0.1 on linux /opt/matlab70
#
# this script depends on the "cluster-matlab" script to determine the number of
# matlab sessions running on each node and by each user
#
# 03nov2011 - roboos: added TORQUEOPTIONS for single thread and nodisplay
# 10mar2012 - roboos: fixed a problem in the PBS_ENVIRONMENT
# 15nov2012 - roboos: allow interactive matlabs on mentat001 and 002 through
#                     torque, ask for mem and walltime
# 07dec2012 - roboos: added xhost+
# 11dec2012 - integrated -noX11tunnel version into main if loop, added support
#             for -local version
# 07mrt2013 - rendbru: added -r matlab input argument with torque execution
# 03may2013 - edwger: added support for mentat003 as torque frontend
# 13nov2013 - edwger: added functionality (function rem_walltime) to calculate
#                     the default walltime until 8pm between 8am and 8pm with a
#                     minimum of 4 hours
# 22nov2013 - edwger: stripped leading zeros from mins_now for minutes
#                     remain calculation (function rem_walltime)
# 25nov2013 - edwger: with the above strip of leading zeros the mins_now var
#                     was empty if mins_now was 00. The var mins_now is now
#                     checked if empty and changed to 0 if so. (function
#                     rem_walltime)
# 25nov2013 - edwger: due to the above changes remaining minutes could result
#                     to 60. Now mins_remain is checked and changed to 00 if
#                     mins_remain is 60 and the var hrs_remain is increased
#                     by 1. (function rem_walltime)
# 17sep2014 - honlee: integration with Environment Modules
#                     1. user login
#                     2. % module load matlab --> here an alias called 'matlab' is created to refer to this script
#                     3. % matlab
# 07jan2015 - honlee: get loaded matlab module from the environment variable $LOADEDMODULES
# 14jan2015 - honlee: improve the code determination of the MATLAB version
# 31mrt2015 - edwger: added support for mentat004 as torque frontend
# 08jun2017 - edwger: added support for the secret -x argument
# 26jun2017 - edwger: Do not reload module if selected module is already loaded
# 10jul2018 - edwger: added support for mentat005 as torque frontend
# 14feb2023 - edwger: added support for mentat006 as torque frontend
#

function get_script_dir() {
    ## resolve the base directory of this executable
    local SOURCE=$1
    while [ -h "$SOURCE" ]; do
        # resolve $SOURCE until the file is no longer a symlink
        DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
        SOURCE="$(readlink "$SOURCE")"

        # if $SOURCE was a relative symlink,
        # we need to resolve it relative to the path
        # where the symlink file was located

        [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
    done

    echo "$( cd -P "$( dirname "$SOURCE" )" && pwd )"
}

##############################################################################
# determine the MATLAB version taking into account the cases below
#  - if the script name indicate the version, always use it
#  - if the script 'matlab' or 'matlabXX' is called, the
#    + use version from preloaded module if available; otherwise,
#    + use default version
##############################################################################

v=$( basename $0 | sed -r 's:matlab::g' | egrep '^[0-9]{4}' )
if [ ! -z $v ] && [ $v == 'XX' ]; then
    v=""
fi

mydir=`get_script_dir $0`

# check if environment module is configured
use_local_mod=0
module list > /dev/null 2>&1
if [ $? -ne 0 ]; then
    use_local_mod=1
    source $mydir/../../_modules/setup.sh
    module load cluster
fi

# load helper functions
source $CLUSTER_UTIL_ROOT/share/matlabXX-lib.sh
source $CLUSTER_UTIL_ROOT/share/cluster-lib.sh

# determin the matlab version to use
if [ ! -z $v ]; then
    # the version indicated by the name of the script
    MATLAB_MODULE="matlab/R${v}"
else
    if [ $use_local_mod -eq 0 ]; then
        # the version pre-loaded by user externally
        MATLAB_MODULE=`getLoadedMatlabModuleFromEnv $LOADEDMODULES`
    else
        # take the default version
        MATLAB_MODULE="matlab"
    fi
fi

#echo "will start $MATLAB_MODULE ..."

# use the short hostname
HOSTNAME=`hostname -s`

##############################################################################
# determine the options for Torque
# MATLAB uses either a single thread  or all threads in a machine
# Torque expects MATLAB to use a single thread, hence this option
##############################################################################
if [ -z "$PBS_O_QUEUE" ]; then
    # the following section applies to all normal mentats, including 001, 002,
    # 003, 004, 005 and 006. It does not apply to the torque execution hosts

    TORQUEREQUEST=$(basename $0 | grep torque)
    NOX11TUNNEL=$(basename $0 | grep noX11tunnel)
    ACCESSNODE=$(echo $HOSTNAME | egrep 'mentat(001|001c|002|003|004|005|006|007|999)')
    TOOLKITNODE=$(echo $HOSTNAME | egrep 'mentat001c')

    if [ -n "$ACCESSNODE" -o -n "$TOOLKITNODE" -o -n "$TORQUEREQUEST" ]; then
        # The following section applies only torque access nodes, toolkits nodes and initiates
        # a torque/maui-job started on one of the torque execution hosts

        # Call the rem_walltime function and use the var remaining_walltime below in the
        # dialog to the user.
        remaining_walltime=`rem_walltime`

        if [ -z $DISPLAY ]; then
            # Exit with error-message if display variable is not set
            echo " "
            echo "No DISPLAY variable set!"
            echo "A DISPLAY setting is required to run Matlab desktop environment."
            echo " "
            echo "You can try to open a new terminal and check your"
            echo "DISPLAY from the command line with:"
            echo "$ echo \$DISPLAY"
            echo " "
            echo "For running matlab in batch mode, please check:"
            echo "https://hpc.dccn.nl/docs/cluster_howto/exercise_matlab/exercise.html"
            echo " "
            exit 0
        fi

        # Get Torque arguments -r or -x, if incorrect exit
        MATLAB_ARGUMENTS=""
        if [ $# -gt 0 ]; then
            if [[ $1 == -* ]]; then
                while getopts r:x option; do
                    case "${option}" in
                        r) MATLAB_ARGUMENTS="${OPTARG}";;
                        x) IMMEDIATE_EXECUTE=TRUE;;
                        ?) echo "Unexpected matlab input argument, only -r option is allowed."; exit 1;;
                    esac
                done
            else
                echo "Unexpected matlab input argument, only -r option is allowed."
                exit 1
            fi
        fi

	#echo $IMMEDIATE_EXECUTE
	if [ $IMMEDIATE_EXECUTE ]
        then
            #echo "here we should execute immediately!!!!"
            echo
            echo -e "\033[1mCongratulations dear researcher!\033[0m"
            echo -e "\033[1mYou discovered our secret, undocumented, -x script argument! ;-)\033[0m"
            echo
            echo -e "By using the -x argument you automatically \033[1mFULLY agree\033[0m to all the choices"
            echo "for jobname, walltime and memory made for you by the DCCN TG!"
            echo
            echo "As an extra bonus for well done research discovering this secret"
            echo -e "option you will get an \033[1mEXTRA\033[0m GigaByte of memory ;-)!"
            echo
            echo -e "Happy matlabbing... and \033[1mPSSST, don't tell anyone...\033[0m"
            echo

            torque_make_display
            module load $MATLAB_MODULE

            WALLTIME=`rem_walltime`
            MEM="4gb"
            name_guiapp="MATLAB"
            trq_queue="interactive"
            MATLABCMD="$MATLAB_BIN -desktop -singleCompThread -display $DISPLAY"
            if [ ! -z "$MATLAB_ARGUMENTS" ]
            then
                echo Running matlab script: $MATLAB_ARGUMENTS
                MATLABCMD="$MATLAB_BIN -desktop -singleCompThread -r $MATLAB_ARGUMENTS -display $DISPLAY"
            fi

            RESRC_REQUIREMENT="walltime=$WALLTIME,mem=$MEM,nodes=1"

            #echo "DCCN_MOD_DIR=$DCCN_MOD_DIR"
            #echo "MATLAB_MODULE=$MATLAB_MODULE"
	    #echo "MATLAB_BIN=$MATLAB_BIN"
            #echo "MATLAB_ARGUMENTS=$MATLAB_ARGUMENTS"
            #echo "DISPLAY=$DISPLAY"
            #echo "walltime=$WALLTIME"
            #echo "mem=$MEM"
            #echo "name_guiapp=$name_guiapp"
            #echo "trq_queue=$trq_queue"

            echo
            echo Requesting immediate interactive MATLAB torque job using:

            echo "source $DCCN_MOD_DIR/setup.sh; module load $MATLAB_MODULE; $MATLABCMD"

            echo
            echo -e "\033[1mSubmitting job for interactive $name_guiapp session ... \033[0m"

            echo "source $DCCN_MOD_DIR/setup.sh; module load $MATLAB_MODULE; ${MATLABCMD}" | qsub -N ${name_guiapp} -l ${RESRC_REQUIREMENT} -q ${trq_queue}

            exit 0
        fi

        $CLUSTER_UTIL_ROOT/bin/matlab-torque-menu $MATLAB_MODULE $MATLAB_ARGUMENTS
        exit 0

    elif [ -n "$NOX11TUNNEL" ]; then

        # try to circumvent the tunneling of X11 over ssh

        if  [ "XX$SSH_CLIENT" = "XX" ]; then
            echo "Unable to detect ssh client origin"
            exit 1
        else
            IP=`echo "$SSH_CLIENT" | cut -d " " -f 1`
            DISPLAYOPTIONS=" -display $IP:0 "
            TORQUEOPTIONS=""
        fi

    else
        # nothing special was requested
        TORQUEOPTIONS=""
        DISPLAYOPTIONS=""
    fi

elif [ "$PBS_ENVIRONMENT" = "PBS_BATCH" ]; then
    TORQUEOPTIONS=" -singleCompThread -nodisplay "

elif [ "$PBS_ENVIRONMENT" = "PBS_INTERACTIVE" ]; then
    TORQUEOPTIONS=" -singleCompThread "
fi

##############################################################################
# start the desired matlab version
##############################################################################

OTHEROPTIONS=$*

# test whether the user is allowed to start another matlab session
export LMSTAT="$CLUSTER_UTIL_ROOT/bin/lmstat -f MATLAB"

# this line can be commented out to quickly disable the test completely
$CLUSTER_UTIL_ROOT/bin/matlabXX-check || exit 1

echo "Starting $MATLAB_MODULE"

## load proper matlab module to get MATLAB_BIN variable
module unload matlab > /dev/null 2>&1
module load $MATLAB_MODULE > /dev/null 2>&1

echo Executing $MATLAB_BIN $TORQUEOPTIONS $DISPLAYOPTIONS $OTHEROPTIONS
exec $MATLAB_BIN $TORQUEOPTIONS $DISPLAYOPTIONS $OTHEROPTIONS
